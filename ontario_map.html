<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ValOre NOBO Investors – Ontario</title>
    <style>
      #map { height: 90vh; width: 100%; }
      body { font-family: Arial, sans-serif; margin: 0; padding: 0; }

      /* Back button */
      #back-button {
        position: absolute;
        top: 15px;
        left: 210px;
        background-color: white;
        padding: 8px 14px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        color: #17193b;
        text-decoration: none;
        font-weight: 600;
        font-size: 13px;
        z-index: 10;
        transition: all 0.2s ease-in-out;
      }
      #back-button:hover {
        background-color: #f2f2f2;
        transform: translateY(-1px);
      }

      /* Floating title */
      h3 {
        position: absolute;
        top: 60px;
        left: 15px;
        background: rgba(255, 255, 255, 0.9);
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 16px;
        color: #17193b;
        z-index: 9;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        margin: 0;
      }

      /* Filter box */
      #filter-box {
        position: absolute;
        top: 125px;
        left: 10px;
        background: white;
        padding: 10px 14px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        font-size: 13px;
        z-index: 5;
        line-height: 1.5;
      }

      /* Legend */
      .legend {
        background: rgba(255, 255, 255, 0.9);
        padding: 8px 12px;
        font-size: 13px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        position: absolute;
        bottom: 25px;
        left: 15px;
        z-index: 5;
        line-height: 1.4;
      }

      .legend img {
        vertical-align: middle;
        margin-right: 6px;
      }

      /* Floating Counters */
      .area-counter {
        position: absolute;
        background: rgba(255, 255, 255, 0.9);
        color: #003366;
        padding: 6px 10px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
        z-index: 8;
      }

      #toronto-counter { top: 150px; right: 40px; }
      #collingwood-counter { top: 210px; right: 40px; }
      #corridor-counter { top: 270px; right: 40px; }
    </style>
  </head>

  <body>
    <a href="index.html" id="back-button">⬅ Back to Dashboard</a>
    <h3>ValOre NOBO Investors – Ontario</h3>
    <div id="map"></div>

    <div id="filter-box">
      <b>Show Clusters:</b><br>
      <label><input type="checkbox" value="Top Priority Contacts" checked> Top Priority</label>
      <label><input type="checkbox" value="High-Potential Contacts" checked> High-Potential</label>
      <label><input type="checkbox" value="Potential Contacts" checked> Potential</label>
      <label><input type="checkbox" value="Low-Potential Contacts" checked> Low-Potential</label>
      <label><input type="checkbox" value="Pending Contact Method" checked> Pending Contact</label>
      <label><input type="checkbox" value="Do Not Contact" checked> Do Not Contact</label>
    </div>

    <div id="legend" class="legend"></div>
    <div id="toronto-counter" class="area-counter">Toronto Area — 0 investors</div>
    <div id="collingwood-counter" class="area-counter">Collingwood Area — 0 investors</div>
    <div id="corridor-counter" class="area-counter">Highway Corridor — 0 investors</div>

    <script>
      async function initMap() {
        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 7,
          center: { lat: 44.1, lng: -79.6 }
        });

        const collingwood = { lat: 44.5008, lng: -80.2144 };
        const airport = { lat: 43.6777, lng: -79.6248 };
        const cityHall = { lat: 43.6532, lng: -79.3832 };

        // Markers
        new google.maps.Marker({
          position: collingwood,
          map,
          icon: { url: "http://maps.google.com/mapfiles/kml/shapes/capital_small.png", scaledSize: new google.maps.Size(30, 30) },
          title: "Collingwood City Hall"
        });
        new google.maps.Marker({
          position: airport,
          map,
          icon: { url: "http://maps.google.com/mapfiles/kml/shapes/airports.png", scaledSize: new google.maps.Size(30, 30) },
          title: "Toronto Pearson Airport"
        });
        new google.maps.Marker({
          position: cityHall,
          map,
          icon: { url: "http://maps.google.com/mapfiles/kml/shapes/capital_small.png", scaledSize: new google.maps.Size(30, 30) },
          title: "Toronto City Hall"
        });

        // Circles (Collingwood + Toronto)
        new google.maps.Circle({
          strokeColor: "#0077B6", strokeOpacity: 0.7, strokeWeight: 1.5,
          fillColor: "#0077B6", fillOpacity: 0.08, map, center: collingwood, radius: 45000
        });
        new google.maps.Circle({
          strokeColor: "#D62828", strokeOpacity: 0.7, strokeWeight: 1.5,
          fillColor: "#D62828", fillOpacity: 0.08, map, center: cityHall, radius: 45000
        });

        // Highway corridor (15 km buffer)
        const corridorPath = [
          { lat: 44.5, lng: -80.22 },
          { lat: 44.39, lng: -79.69 },
          { lat: 43.90, lng: -79.51 },
          { lat: 43.65, lng: -79.38 }
        ];
        new google.maps.Polyline({
          path: corridorPath,
          geodesic: true,
          strokeColor: "#D62828",
          strokeOpacity: 0.9,
          strokeWeight: 2,
          icons: [{
            icon: { path: google.maps.SymbolPath.CIRCLE, scale: 0 },
            offset: "0"
          }],
          map
        });

        // Investors
        const response = await fetch("investors.json");
        const investors = await response.json();
        const investorsON = investors.filter(inv => inv.province?.toUpperCase() === "ONTARIO");

        const clusterIcons = {
          "Top Priority Contacts": "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
          "High-Potential Contacts": "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
          "Potential Contacts": "http://maps.google.com/mapfiles/ms/icons/purple-dot.png",
          "Low-Potential Contacts": "http://maps.google.com/mapfiles/ms/icons/pink-dot.png",
          "Pending Contact Method": "http://maps.google.com/mapfiles/ms/icons/orange-dot.png",
          "Do Not Contact": "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png"
        };

        const markers = [];
        investorsON.forEach(inv => {
          if (inv.lat && inv.lon) {
            const marker = new google.maps.Marker({
              position: { lat: inv.lat, lng: inv.lon },
              map,
              icon: { url: clusterIcons[inv.cluster], scaledSize: new google.maps.Size(18, 18) },
              title: inv.name
            });
            markers.push({ marker, cluster: inv.cluster, lat: inv.lat, lon: inv.lon });
          }
        });

        // Update visible counters dynamically
        function updateCounters() {
          const visible = markers.filter(m => m.marker.getVisible());
          const toronto = visible.filter(m => m.lat < 44 && m.lon > -80.1);
          const collingwood = visible.filter(m => m.lat > 44.3 && m.lon < -79.9);
          const corridor = visible.filter(m => m.lat > 43.7 && m.lat < 44.4 && m.lon > -80.2 && m.lon < -79.4);

          document.getElementById("toronto-counter").textContent = `Toronto Area — ${toronto.length} investors`;
          document.getElementById("collingwood-counter").textContent = `Collingwood Area — ${collingwood.length} investors`;
          document.getElementById("corridor-counter").textContent = `Highway Corridor — ${corridor.length} investors`;
        }

        // Filter logic
        const checkboxes = document.querySelectorAll('#filter-box input[type="checkbox"]');
        checkboxes.forEach(cb => {
          cb.addEventListener("change", () => {
            const active = Array.from(checkboxes).filter(c => c.checked).map(c => c.value);
            markers.forEach(m => m.marker.setVisible(active.includes(m.cluster)));
            updateCounters();
          });
        });

        updateCounters();
      }
    </script>

    <script src="config.js"></script>
    <script>
      const script = document.createElement("script");
      script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.GOOGLE_MAPS_API_KEY}&callback=initMap`;
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    </script>
  </body>
</html>
