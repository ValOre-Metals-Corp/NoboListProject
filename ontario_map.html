import pandas as pd
import requests
import time
import folium

API_KEY = "AIzaSyDy3FD3k3MpOnMGZvfo7IOeq9SKESf35fg"  # your Google API key
file_path = "data/Nobo_list_lat_lon.csv"

# --------------------------------------------------------
# Coordinates: Toronto references
# --------------------------------------------------------
CITY_HALL = (43.6532, -79.3832)   # Toronto City Hall
AIRPORT = (43.6777, -79.6248)     # Toronto Pearson International Airport
COLLINGWOOD = (44.5007, -80.2169) # Collingwood Town Hall (reference)

# --------------------------------------------------------
# Load CSV and filter Ontario
# --------------------------------------------------------
df = pd.read_csv(file_path)
df_on = df[df["PROV"].str.upper() == "ON"].copy()

# --------------------------------------------------------
# Distance + time calculation using Google API
# --------------------------------------------------------
def get_distance_and_time(lat1, lon1, lat2, lon2):
    url = (
        f"https://maps.googleapis.com/maps/api/distancematrix/json?"
        f"origins={lat1},{lon1}&destinations={lat2},{lon2}&key={API_KEY}"
    )
    r = requests.get(url)
    data = r.json()

    try:
        element = data["rows"][0]["elements"][0]
        dist_km = element["distance"]["value"] / 1000
        time_min = element["duration"]["value"] / 60
        return dist_km, time_min
    except Exception:
        return None, None

# --------------------------------------------------------
# Add empty columns
# --------------------------------------------------------
df_on["DIST_TO_CITY_HALL_KM"] = None
df_on["TIME_TO_CITY_HALL_MIN"] = None
df_on["DIST_TO_AIRPORT_KM"] = None
df_on["TIME_TO_AIRPORT_MIN"] = None

# --------------------------------------------------------
# Compute distances
# --------------------------------------------------------
for i, row in df_on.iterrows():
    lat, lon = row["lat_y"], row["lon_y"]

    dist_city, time_city = get_distance_and_time(lat, lon, *CITY_HALL)
    dist_air, time_air = get_distance_and_time(lat, lon, *AIRPORT)

    df_on.at[i, "DIST_TO_CITY_HALL_KM"] = dist_city
    df_on.at[i, "TIME_TO_CITY_HALL_MIN"] = time_city
    df_on.at[i, "DIST_TO_AIRPORT_KM"] = dist_air
    df_on.at[i, "TIME_TO_AIRPORT_MIN"] = time_air

    print(f"{i}: {row['CITY']} ✅")
    time.sleep(0.2)

# --------------------------------------------------------
# Save output
# --------------------------------------------------------
output_path = "data/Nobo_ON_Distances.csv"
df_on.to_csv(output_path, index=False)
print(f"✅ Distances and travel times (Ontario) saved to: {output_path}")

# --------------------------------------------------------
# Create Map with Highways
# --------------------------------------------------------
m = folium.Map(location=[44.2, -79.8], zoom_start=8)

# Add reference points
folium.Marker(COLLINGWOOD, popup="Collingwood", icon=folium.Icon(color='blue')).add_to(m)
folium.Marker(CITY_HALL, popup="Toronto City Hall", icon=folium.Icon(color='green')).add_to(m)
folium.Marker(AIRPORT, popup="Toronto Pearson Airport", icon=folium.Icon(color='gray')).add_to(m)

# Approximate routes for Highway 400 and Highway 10
highway_400_route = [
    COLLINGWOOD,
    [44.39, -79.69],  # Barrie
    [43.90, -79.51],  # Vaughan
    CITY_HALL
]

highway_10_route = [
    COLLINGWOOD,
    [44.30, -80.00],  # Shelburne
    [43.90, -79.90],  # Brampton/Caledon
    CITY_HALL
]

# Draw the highways
folium.PolyLine(highway_400_route, color='red', weight=4, opacity=0.8, tooltip='Highway 400').add_to(m)
folium.PolyLine(highway_10_route, color='orange', weight=4, opacity=0.8, tooltip='Highway 10').add_to(m)

# --------------------------------------------------------
# Optional: Add legend manually (HTML overlay)
# --------------------------------------------------------
legend_html = '''
<div style="
position: fixed; 
bottom: 50px; left: 50px; width: 180px; height: 70px; 
border:2px solid grey; z-index:9999; font-size:14px;
background-color:white; padding: 8px;">
<b>Legend</b><br>
<span style="color:red;">&#8212;&#8212;&#8212;</span> Highway 400<br>
<span style="color:orange;">&#8212;&#8212;&#8212;</span> Highway 10
</div>
'''
m.get_root().html.add_child(folium.Element(legend_html))

# --------------------------------------------------------
# Save or display map
# --------------------------------------------------------
m.save("data/Ontario_Highways_Map.html")
print("✅ Map with highways saved as: data/Ontario_Highways_Map.html")
m
