<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ValOre NOBO Investors – Ontario</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    #map {
      height: 90vh;
      width: 100%;
    }

    #back-button {
      position: absolute;
      top: 15px;
      left: 210px;
      background-color: white;
      padding: 8px 14px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      color: #17193b;
      text-decoration: none;
      font-weight: 600;
      font-size: 13px;
      z-index: 10;
    }

    #back-button:hover {
      background-color: #f2f2f2;
    }

    h3 {
      position: absolute;
      top: 60px;
      left: 15px;
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 16px;
      color: #17193b;
      z-index: 9;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
      margin: 0;
    }

    /* Filter box */
    #filter-box {
      position: absolute;
      top: 115px;
      left: 10px;
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      font-size: 12.5px;
      z-index: 5;
      line-height: 1.4;
      width: 180px;
    }

    #filter-box b {
      display: block;
      margin-bottom: 3px;
      color: #17193b;
      font-size: 13px;
    }

    #filter-box label {
      display: block;
      margin: 2px 0;
      white-space: nowrap;
    }

    /* Legend */
    .legend {
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 12px;
      font-size: 12.5px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      position: absolute;
      bottom: 25px;
      left: 15px;
      z-index: 5;
      line-height: 1.4;
      width: 180px;
    }

    .legend b {
      display: block;
      margin-bottom: 3px;
      color: #17193b;
      font-size: 13px;
    }

    .legend div {
      margin: 2px 0;
      display: flex;
      align-items: center;
    }

    .legend img {
      vertical-align: middle;
      margin-right: 5px;
      width: 14px;
      height: 14px;
    }

    /* Area counter box */
    #area-counter {
      position: absolute;
      bottom: 30px;
      right: 25px;
      background: white;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
      font-size: 13px;
      line-height: 1.5;
      color: #17193b;
      z-index: 6;
      width: 220px;
    }

    #area-counter b {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
    }
  </style>
</head>

<body>
  <a href="index.html" id="back-button">⬅ Back to Dashboard</a>
  <h3>ValOre NOBO Investors – Ontario</h3>
  <div id="map"></div>

  <div id="filter-box">
    <b>Show Clusters:</b>
    <label><input type="checkbox" value="Top Priority Contacts" checked> Top Priority</label>
    <label><input type="checkbox" value="High-Potential Contacts" checked> High-Potential</label>
    <label><input type="checkbox" value="Potential Contacts" checked> Potential</label>
    <label><input type="checkbox" value="Low-Potential Contacts" checked> Low-Potential</label>
    <label><input type="checkbox" value="Pending Contact Method" checked> Pending Contact Method</label>
    <label><input type="checkbox" value="Do Not Contact" checked> Do Not Contact</label>
  </div>

  <div id="legend" class="legend"><b>Legend</b></div>

  <div id="area-counter">
    <b>Area Counters</b>
    <div>Toronto 40 km: <span id="count-toronto">0</span></div>
    <div>Collingwood 40 km: <span id="count-collingwood">0</span></div>
    <div>Corridor (15 km): <span id="count-corridor">0</span></div>
    <hr>
    <div><b>Total visible:</b> <span id="count-total">0</span></div>
  </div>

  <script>
    async function initMap() {
      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 7,
        center: { lat: 44.1, lng: -79.6 },
      });

      // Reference points
      const collingwood = { lat: 44.5008, lng: -80.2144 };
      const toronto = { lat: 43.6532, lng: -79.3832 };

      // City markers
      new google.maps.Marker({
        position: collingwood,
        map,
        icon: {
          url: "http://maps.google.com/mapfiles/kml/shapes/capital_small.png",
          scaledSize: new google.maps.Size(36, 36),
        },
        title: "Collingwood City Hall",
      });

      new google.maps.Marker({
        position: toronto,
        map,
        icon: {
          url: "http://maps.google.com/mapfiles/kml/shapes/capital_small.png",
          scaledSize: new google.maps.Size(36, 36),
        },
        title: "Toronto City Hall",
      });

      // Circles
      new google.maps.Circle({
        strokeColor: "#0066FF",
        strokeOpacity: 0.7,
        strokeWeight: 2,
        fillColor: "#0066FF",
        fillOpacity: 0.08,
        map,
        center: toronto,
        radius: 40000,
      });

      new google.maps.Circle({
        strokeColor: "#FF9900",
        strokeOpacity: 0.7,
        strokeWeight: 2,
        fillColor: "#FF9900",
        fillOpacity: 0.08,
        map,
        center: collingwood,
        radius: 40000,
      });

      // Highways (dashed black)
      const highway400 = [
        collingwood,
        { lat: 44.39, lng: -79.69 },
        { lat: 43.9, lng: -79.51 },
        toronto,
      ];
      const highway10 = [
        collingwood,
        { lat: 44.3, lng: -80.0 },
        { lat: 43.9, lng: -79.9 },
        toronto,
      ];

      [highway400, highway10].forEach((path) => {
        new google.maps.Polyline({
          path: path,
          geodesic: true,
          strokeColor: "#000000",
          strokeOpacity: 0.8,
          strokeWeight: 2,
          icons: [
            {
              icon: { path: "M 0,-1 0,1", strokeOpacity: 1, scale: 4 },
              offset: "0",
              repeat: "20px",
            },
          ],
          map,
        });
      });

      // Corridor polygon (15 km buffer)
      const corridor = [
        { lat: 44.62, lng: -80.35 },
        { lat: 44.48, lng: -79.58 },
        { lat: 44.05, lng: -79.3 },
        { lat: 43.6, lng: -79.35 },
        { lat: 43.55, lng: -79.85 },
        { lat: 43.85, lng: -80.15 },
        { lat: 44.35, lng: -80.25 },
        { lat: 44.62, lng: -80.35 },
      ];

      new google.maps.Polygon({
        paths: corridor,
        strokeColor: "#FF0000",
        strokeOpacity: 0.9,
        strokeWeight: 3,
        fillOpacity: 0,
        map,
      });

      // Load investors
      const response = await fetch("investors.json");
      const allInvestors = await response.json();
      const investorsON = allInvestors.filter(
        (i) => i.province?.toUpperCase() === "ONTARIO"
      );

      const clusterIcons = {
        "Top Priority Contacts": "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
        "High-Potential Contacts": "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
        "Potential Contacts": "http://maps.google.com/mapfiles/ms/icons/purple-dot.png",
        "Low-Potential Contacts": "http://maps.google.com/mapfiles/ms/icons/pink-dot.png",
        "Pending Contact Method": "http://maps.google.com/mapfiles/ms/icons/orange-dot.png",
        "Do Not Contact": "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png",
      };

      const markers = [];

      investorsON.forEach((inv) => {
        if (inv.lat && inv.lon) {
          const latOffset = (Math.random() - 0.5) * 0.0006;
          const lonOffset = (Math.random() - 0.5) * 0.0006;
          const marker = new google.maps.Marker({
            position: { lat: inv.lat + latOffset, lng: inv.lon + lonOffset },
            map,
            icon: {
              url: clusterIcons[inv.cluster] || "http://maps.google.com/mapfiles/ms/icons/grey-dot.png",
              scaledSize: new google.maps.Size(18, 18),
            },
            title: `${inv.name} (${inv.cluster})`,
          });
          markers.push({ marker, cluster: inv.cluster });
        }
      });

      // Legend and counter
      const legend = document.getElementById("legend");
      legend.innerHTML = "<b>Legend</b>";
      for (const [c, url] of Object.entries(clusterIcons)) {
        const div = document.createElement("div");
        div.innerHTML = `<img src="${url}"> ${c}`;
        legend.appendChild(div);
      }

      legend.innerHTML += `
        <hr>
        <div><span style="color:#FF0000;">&#8212;&#8212;&#8212;</span> Corridor (15 km buffer around Highways 400 & 10)</div>
        <div><span style="color:#000;">&#8212;&#8212;&#8212;</span> Highways 400 & 10 (Dashed)</div>
        <div><span style="color:#0066FF;">⬤</span> Toronto 40 km radius</div>
        <div><span style="color:#FF9900;">⬤</span> Collingwood 40 km radius</div>
      `;

      const counterDiv = document.createElement("div");
      counterDiv.id = "counter";
      legend.appendChild(counterDiv);
      map.getDiv().appendChild(legend);

      // Core functions
      function updateCounter() {
        const visibleCount = markers.filter((o) => o.marker.getVisible()).length;
        counterDiv.textContent = `Visible Investors: ${visibleCount}`;
      }

      function distance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a =
          Math.sin(dLat / 2) ** 2 +
          Math.cos(lat1 * Math.PI / 180) *
          Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLon / 2) ** 2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      }

      function pointInPolygon(point, vs) {
        const x = point.lng, y = point.lat;
        let inside = false;
        for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
          const xi = vs[i].lng, yi = vs[i].lat;
          const xj = vs[j].lng, yj = vs[j].lat;
          const intersect = ((yi > y) !== (yj > y)) &&
            (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
          if (intersect) inside = !inside;
        }
        return inside;
      }

      function updateAreaCounters() {
  let torontoCount = 0, collingwoodCount = 0, corridorCount = 0;
  
  markers.forEach(o => {
    if (!o.marker.getVisible()) return;

    // Use original coordinates from dataset (without offsets)
    const inv = investorsON.find(i => i.lat && i.lon && i.name === o.marker.getTitle().split(" (")[0]);
    if (!inv) return;
    const lat = inv.lat, lon = inv.lon;

    const dToronto = distance(lat, lon, toronto.lat, toronto.lng);
    const dCollingwood = distance(lat, lon, collingwood.lat, collingwood.lng);
    const insideToronto = dToronto <= 40;
    const insideCollingwood = dCollingwood <= 40;
    const insideCorridor = pointInPolygon({ lat, lng: lon }, corridor);

    // Hierarchical priority
    if (insideToronto) {
      torontoCount++;
    } else if (insideCollingwood) {
      collingwoodCount++;
    } else if (insideCorridor) {
      corridorCount++;
    }
  });

  // Update UI
  document.getElementById("count-toronto").textContent = torontoCount;
  document.getElementById("count-collingwood").textContent = collingwoodCount;
  document.getElementById("count-corridor").textContent = corridorCount;
  document.getElementById("count-total").textContent =
    markers.filter(o => o.marker.getVisible()).length;
}
      // Filter logic
      const checkboxes = document.querySelectorAll('#filter-box input[type="checkbox"]');
      checkboxes.forEach(cb => {
        cb.addEventListener("change", () => {
          const active = Array.from(checkboxes)
            .filter(c => c.checked)
            .map(c => c.value);
          markers.forEach(o => o.marker.setVisible(active.includes(o.cluster)));
          updateCounter();
          updateAreaCounters();
        });
      });

      // Initial updates
      updateCounter();
      updateAreaCounters();
    }
  </script>

  <script src="config.js"></script>
  <script>
    const script = document.createElement("script");
    script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.GOOGLE_MAPS_API_KEY}&callback=initMap`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
  </script>
</body>
</html>
