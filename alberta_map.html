<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ValOre NOBO Investors ‚Äì Alberta</title>
  <style>
    #map { height: 90vh; width: 100%; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }

    /* üîπ Bot√£o de retorno */
    #back-button {
      position: absolute;
      top: 15px;
      left: 210px;
      background-color: white;
      padding: 8px 14px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      color: #17193b;
      text-decoration: none;
      font-weight: 600;
      font-size: 13px;
      z-index: 10;
      transition: all 0.2s ease-in-out;
    }
    #back-button:hover {
      background-color: #f2f2f2;
      transform: translateY(-1px);
    }

    /* üîπ T√≠tulo flutuante */
    h3 {
      position: absolute;
      top: 60px;
      left: 15px;
      background: rgba(255,255,255,0.9);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 16px;
      color: #17193b;
      z-index: 9;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      margin: 0;
    }

    /* üîπ Caixa de sele√ß√£o */
    #filter-box {
      position: absolute;
      top: 125px;
      left: 10px;
      background: white;
      padding: 12px 16px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      font-size: 14px;
      z-index: 5;
      line-height: 1.6;
    }

    #filter-box b {
      display: block;
      margin-bottom: 4px;
      color: #17193b;
    }

    #filter-box label {
      display: block;
      margin: 3px 0;
    }

    /* üîπ Legenda */
    .legend {
      background: rgba(255,255,255,0.95);
      padding: 12px 14px;
      font-size: 14px;
      font-family: Arial, sans-serif;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      line-height: 1.6;
      position: absolute;
      bottom: 25px;
      left: 15px;
      z-index: 5;
    }

    .legend img {
      vertical-align: middle;
      margin-right: 6px;
    }

    /* üîπ Contador */
    #counter {
      margin-top: 8px;
      font-weight: bold;
      text-align: center;
      color: #17193b;
    }
  </style>
</head>

<body>
  <a href="index.html" id="back-button">‚¨Ö Back to Dashboard</a>
  <h3>ValOre NOBO Investors ‚Äì Alberta</h3>
  <div id="map"></div>

  <!-- Caixa de sele√ß√£o -->
  <div id="filter-box">
    <b>Show Clusters:</b>
    <label><input type="checkbox" value="Top Priority Contacts" checked> Top Priority</label>
    <label><input type="checkbox" value="High-Potential Contacts" checked> High-Potential</label>
    <label><input type="checkbox" value="Potential Contacts" checked> Potential</label>
    <label><input type="checkbox" value="Low-Potential Contacts" checked> Low-Potential</label>
    <label><input type="checkbox" value="Pending Contact Method" checked> Pending Contact Method</label>
    <label><input type="checkbox" value="Do Not Contact" checked> Do Not Contact</label>
  </div>

  <div id="legend" class="legend"><b>Legend</b></div>

  <script>
    async function initMap() {
      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 6,
        center: { lat: 52.3, lng: -113.9 } // Centralizado entre Calgary e Edmonton
      });

      // === Pontos fixos - CALGARY ===
      const calgaryAirport = { lat: 51.1314, lng: -114.0106 };
      const calgaryCityHall = { lat: 51.0447, lng: -114.0719 };

      new google.maps.Marker({
        position: calgaryAirport,
        map,
        icon: { url: "http://maps.google.com/mapfiles/kml/shapes/airports.png", scaledSize: new google.maps.Size(40, 40) },
        title: "Calgary International Airport"
      });

      new google.maps.Marker({
        position: calgaryCityHall,
        map,
        icon: { url: "http://maps.google.com/mapfiles/kml/shapes/capital_small.png", scaledSize: new google.maps.Size(40, 40) },
        title: "Calgary City Hall"
      });

      // === C√≠rculos de Calgary ===
      new google.maps.Circle({
        strokeColor: "#0000FF", strokeOpacity: 0.6, strokeWeight: 2,
        fillColor: "#0000FF", fillOpacity: 0.1, map, center: calgaryAirport, radius: 30000
      });
      new google.maps.Circle({
        strokeColor: "#FF0000", strokeOpacity: 0.6, strokeWeight: 2,
        fillColor: "#FF0000", fillOpacity: 0.1, map, center: calgaryCityHall, radius: 20000
      });

      // === Pontos fixos - EDMONTON ===
      const edmontonAirport = { lat: 53.3097, lng: -113.5797 };
      const edmontonCityHall = { lat: 53.5444, lng: -113.4909 };

      new google.maps.Marker({
        position: edmontonAirport,
        map,
        icon: { url: "http://maps.google.com/mapfiles/kml/shapes/airports.png", scaledSize: new google.maps.Size(40, 40) },
        title: "Edmonton International Airport"
      });

      new google.maps.Marker({
        position: edmontonCityHall,
        map,
        icon: { url: "http://maps.google.com/mapfiles/kml/shapes/capital_small.png", scaledSize: new google.maps.Size(40, 40) },
        title: "Edmonton City Hall"
      });

      // === C√≠rculos de Edmonton ===
      new google.maps.Circle({
        strokeColor: "#0000FF", strokeOpacity: 0.6, strokeWeight: 2,
        fillColor: "#0000FF", fillOpacity: 0.1, map, center: edmontonAirport, radius: 30000
      });
      new google.maps.Circle({
        strokeColor: "#FF0000", strokeOpacity: 0.6, strokeWeight: 2,
        fillColor: "#FF0000", fillOpacity: 0.1, map, center: edmontonCityHall, radius: 20000
      });

      // === Ler investidores ===
      const response = await fetch("investors.json");
      const allInvestors = await response.json();
      const investorsAB = allInvestors.filter(inv =>
        inv.province && inv.province.toUpperCase() === "ALBERTA"
      );

      // === √çcones por cluster ===
      const clusterIcons = {
          "Top Priority Contacts": "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
          "High-Potential Contacts": "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
          "Potential Contacts": "http://maps.google.com/mapfiles/ms/icons/purple-dot.png",
          "Low-Potential Contacts": "http://maps.google.com/mapfiles/ms/icons/pink-dot.png",
          "Pending Contact Method": "http://maps.google.com/mapfiles/ms/icons/orange-dot.png",
          "Do Not Contact": "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png"
      };


     // === Criar marcadores (com corre√ß√£o para coordenadas duplicadas) ===
      const markers = [];
      const usedCoords = new Set();

      investorsAB.forEach(inv => {
        if (inv.lat && inv.lon) {
          let lat = inv.lat;
          let lon = inv.lon;
          const coordKey = `${lat.toFixed(4)},${lon.toFixed(4)}`;

          // Evita sobreposi√ß√£o
          if (usedCoords.has(coordKey)) {
            const offset = (Math.random() - 0.5) * 0.001;
            lat += offset;
            lon += offset;
          }
          usedCoords.add(coordKey);

          const marker = new google.maps.Marker({
            position: { lat, lng: lon },
            map,
            icon: clusterIcons[inv.cluster] || "http://maps.google.com/mapfiles/ms/icons/ltblue-dot.png",
            title: `${inv.name} (${inv.cluster})`
          });

         // Define a cidade de refer√™ncia automaticamente
const referenceCity =
  inv.nearest_city && inv.nearest_city.toLowerCase().includes("edmont")
    ? "Edmonton"
    : "Calgary";

const info = new google.maps.InfoWindow({
  content: `
    <div style="font-size:14px; line-height:1.4; max-width:280px;">
      <b>${inv.name}</b><br>
      <b>City:</b> ${inv.city || "N/A"}<br>
      <b>Shares:</b> ${Number(inv.shares).toLocaleString()}<br>
      <b>Tier:</b> ${inv.tier || "N/A"}<br>
      <b>Cluster:</b> ${inv.cluster || "N/A"}<br>

      <hr style="margin:6px 0;">
      <b>Regional Data (FSA):</b><br>
      Avg. Income: $${Number(inv.income).toLocaleString('en-US', { maximumFractionDigits: 0 })}<br>
      Avg. Age: ${Math.round(inv.age)} years

      <hr style="margin:6px 0;">
      <b>Distances (from ${referenceCity}):</b><br>
      üõ´ <b>Airport:</b> ${inv.dist_to_airport_km?.toFixed(1) || "N/A"} km ‚Ä¢ ${Math.round(inv.time_to_airport_min) || "N/A"} min<br>
      üèõÔ∏è <b>City Hall:</b> ${inv.dist_to_cityhall_km?.toFixed(1) || "N/A"} km ‚Ä¢ ${Math.round(inv.time_to_cityhall_min) || "N/A"} min
    </div>
  `
});
          marker.addListener("click", () => info.open(map, marker));
          markers.push({ marker, cluster: inv.cluster });
        }
      });

      // === Legenda ===
      const legend = document.getElementById("legend");
      for (const [cluster, iconUrl] of Object.entries(clusterIcons)) {
        const div = document.createElement("div");
        div.innerHTML = `<img src="${iconUrl}"> ${cluster}`;
        legend.appendChild(div);
      }

      // üîπ Contador
      const counterDiv = document.createElement("div");
      counterDiv.id = "counter";
      counterDiv.textContent = "Visible Investors: 0";
      legend.appendChild(counterDiv);
      map.getDiv().appendChild(legend);

      function updateCounter() {
        const visibleCount = markers.filter(obj => obj.marker.getVisible()).length;
        counterDiv.textContent = `Visible Investors: ${visibleCount}`;
      }

      // === Filtros (corrigido) ===
      const checkboxes = document.querySelectorAll('#filter-box input[type="checkbox"]');
      checkboxes.forEach(cb => {
        cb.addEventListener("change", () => {
          const activeClusters = Array.from(checkboxes)
            .filter(c => c.checked)
            .map(c => c.value);

          markers.forEach(obj => {
            obj.marker.setVisible(activeClusters.includes(obj.cluster));
          });

          updateCounter();
        });
      });

      updateCounter();
    }
  </script>

  <script src="config.js"></script>
  <script>
    const script = document.createElement("script");
    script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.GOOGLE_MAPS_API_KEY}&callback=initMap`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
  </script>
</body>
</html>
